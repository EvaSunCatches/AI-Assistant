/**
 * AI Educational Assistant ‚Äî OCR Analyzer (v5.9-STABLE)
 * CommonJS backend, minimal functional version
 */

const express = require("express");
const fs = require("fs-extra");
const path = require("path");
const sharp = require("sharp");
const multer = require("multer");
const morgan = require("morgan");
const tesseract = require("node-tesseract-ocr");

const app = express();
const PORT = process.env.PORT || 3000;

// === Paths ===
const PUBLIC_DIR = path.join(__dirname, "public");
const DRAWINGS_DIR = path.join(PUBLIC_DIR, "drawings");
const LOG_FILE = path.join(__dirname, "logs", "ocr.json");
const LOGS_DIR = path.join(__dirname, "logs");

// === Ensure folders exist ===
fs.ensureDirSync(DRAWINGS_DIR);
fs.ensureDirSync(LOGS_DIR);

// === Multer config ===
const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, DRAWINGS_DIR),
  filename: (req, file, cb) => {
    const unique = Date.now();
    const safe = file.originalname.replace(/\s+/g, "_");
    cb(null, `ocr-${unique}-${safe}`);
  },
});
const upload = multer({ storage });

// === Middlewares ===
app.use(morgan("dev"));
app.use(express.json());
app.use(express.static(PUBLIC_DIR));

// === Create index.html if missing ===
const indexPath = path.join(PUBLIC_DIR, "index.html");
if (!fs.existsSync(indexPath)) {
  const html = `
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>OCR –ê–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä (AI Educational Assistant)</title>
  <style>
    body { font-family: sans-serif; margin: 2em; background: #fafafa; }
    h1 { color: #333; }
    #output { white-space: pre-wrap; background: #fff; padding: 1em; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>üß† OCR –ê–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä</h1>
  <input type="file" id="fileInput" />
  <button id="btn">–†–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏</button>
  <button id="clear">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
  <pre id="output"></pre>
  <script>
    document.getElementById('btn').onclick = async () => {
      const f = document.getElementById('fileInput').files[0];
      if (!f) return alert('–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª!');
      const fd = new FormData();
      fd.append('file', f);
      const res = await fetch('/api/vision', { method: 'POST', body: fd });
      const txt = await res.text();
      try {
        document.getElementById('output').textContent = JSON.stringify(JSON.parse(txt), null, 2);
      } catch(e) {
        document.getElementById('output').textContent = txt;
      }
    };
    document.getElementById('clear').onclick = async () => {
      await fetch('/api/clear', { method: 'POST' });
      document.getElementById('output').textContent = '‚úÖ –û—á–∏—â–µ–Ω–æ';
    };
  </script>
</body>
</html>`;
  fs.writeFileSync(indexPath, html);
}

// === Helpers ===
const readLogs = async () => {
  try {
    const data = await fs.readFile(LOG_FILE, "utf-8");
    return JSON.parse(data || "[]");
  } catch {
    return [];
  }
};

const saveLogs = async (entries) =>
  fs.writeFile(LOG_FILE, JSON.stringify(entries.slice(-50), null, 2));

// === OCR endpoint ===
app.post("/api/vision", upload.single("file"), async (req, res) => {
  try {
    if (!req.file) return res.status(400).json({ error: "–§–∞–π–ª –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ" });

    const filePath = req.file.path;
    const text = await tesseract.recognize(filePath, { lang: "ukr+eng" });

    // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è (–ø–æ —à–∞–±–ª–æ–Ω—É "312.", "313." –∏ —Ç.–¥.)
    const taskMatch = text.match(/\b\d{3,4}\./);
    const task = taskMatch ? taskMatch[0].replace(".", "") : null;

    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∏—Å—É–Ω–∫–æ–≤
    const drawings = [...text.matchAll(/–†–∏—Å\.?\s?(\d+)/gi)].map((m) => m[1]);

    const entry = {
      status: task ? "‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ" : "‚ÑπÔ∏è –¢–µ–∫—Å—Ç —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ, –∑–∞–≤–¥–∞–Ω–Ω—è –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ",
      task,
      drawings,
      text: text.trim(),
      file: `/public/drawings/${path.basename(filePath)}`,
      timestamp: new Date().toISOString(),
    };

    const logs = await readLogs();
    logs.push(entry);
    await saveLogs(logs);

    res.json(entry);
  } catch (err) {
    console.error("‚ùå OCR error:", err);
    res.status(500).json({ error: "–ü–æ–º–∏–ª–∫–∞ OCR –∞–±–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É" });
  }
});

// === –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –∏ —Ä–∏—Å—É–Ω–∫–æ–≤ ===
app.post("/api/clear", async (_req, res) => {
  try {
    await fs.writeFile(LOG_FILE, "[]");
    await fs.emptyDir(DRAWINGS_DIR);
    res.json({ cleared: true });
  } catch (err) {
    console.error("Clear error:", err);
    res.status(500).json({ error: "–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è" });
  }
});

// === Health check ===
app.get("/health", (_req, res) => {
  res.json({
    status: "‚úÖ OK",
    version: "v5.9-STABLE",
    endpoints: ["/api/vision", "/api/clear", "/health"],
  });
});

// === Auto-cleanup every 3 min ===
setInterval(async () => {
  try {
    await fs.emptyDir(DRAWINGS_DIR);
    await saveLogs(await readLogs());
  } catch {}
}, 180000);

// === Start server ===
app.listen(PORT, () => {
  console.log(`‚úÖ server.cjs v5.9-STABLE running on http://localhost:${PORT}`);
  console.log(`üìÅ Drawings: ${DRAWINGS_DIR}`);
  console.log(`üìÅ Logs: ${LOG_FILE}`);
  console.log(`üïí Auto-cleanup: 180 sec`);
});

// export (for tests)
module.exports = app;